### Issue #7 実装状況サマリーと今後の実装案

**現在の実装状況:**

Issue #7 で定義された機能のうち、以下の項目は実装済み、または部分的に実装されています。

*   **HTTPサーバー機能**: ローカルファイルの基本的なHTTP提供は実装済みですが、MIMEタイプ検出、HTTP Rangeリクエスト、CORSヘッダー、標準入力からのデータストリーミングは未実装です。
*   **コマンドライン引数解析**: `clap` クレートを使用した基本的な引数解析は実装済みです。プレフィックス付きオプションの抽出は未実装です。
*   **Chromecast連携**: デバイスの検出と基本的なメディア制御（ロード、再生、一時停止、停止、シーク、音量調整）は実装済みです。
*   **メディアメタデータ処理**: `id3` クレートを使用したオーディオファイルからのID3タグ抽出は実装済みです。カバーアートのリサイズと変換は未実装です。
*   **コンソールUI**: `crossterm` クレートを使用したキーボード入力による操作ハンドリングと、基本的な再生状況の表示は実装済みです。
*   **エラーハンドリング**: `anyhow` を使用したエラー伝播は行われていますが、カスタムエラー型の定義や詳細なユーザー通知は不足しています。

**未実装の主要機能:**

*   **HTTPサーバー機能の高度な側面**: MIMEタイプ検出、HTTP Rangeリクエスト、CORSヘッダー、標準入力からのデータストリーミング。
*   **コマンドライン引数解析**: `--peerflix-`, `--ffmpeg-` のようなプレフィックス付きオプションの抽出。
*   **時間フォーマット変換**: `hh:mm:ss` または `mm:ss` 形式の文字列を秒に変換するユーティリティ。
*   **ファイルシステム操作**: ディレクトリの再帰的探索とメディアファイルのフィルタリング（`walkdir` クレートの利用）。
*   **プレイリスト管理**: メディアアイテムのキューイング、ループ再生、シャッフル再生ロジック。
*   **メディアメタデータ処理**: カバーアートのリサイズと変換。
*   **エラーハンドリング**: カスタムエラー型の定義と、より詳細なユーザー向けエラー通知。

**最終の実装案:**

Issue #7 のコメントで提案されている `warp` クレートは、HTTP Rangeリクエストのサポートにおいて `warp-range` という専用ライブラリが存在するため、非常に有力な選択肢です。現在の `hyper` を直接使用した実装では、RangeリクエストやMIMEタイプ検出、CORSヘッダーなどの実装が複雑になるため、HTTPサーバー部分を `warp` に移行することを推奨します。

**具体的な実装ステップ:**

1.  **HTTPサーバーの `warp` への移行**:
    *   `src/server.rs` を `warp` ベースに書き換えます。
    *   `warp-range` クレートを導入し、HTTP Rangeリクエストをサポートします。
    *   `mime_guess` クレートを導入し、ファイル拡張子に基づいたMIMEタイプ検出を実装します。
    *   CORSヘッダーを適切に設定します。
    *   可能であれば、標準入力からのデータストリーミングも検討します。
2.  **プレイリスト管理機能の強化**:
    *   `src/main.rs` の `handle_playlist_file` を拡張し、解析したプレイリストエントリをキューとして管理するロジックを追加します。
    *   `loop_playback` と `shuffle` の設定に基づいて、再生ロジックを実装します。
3.  **ファイルシステム操作の強化**:
    *   `walkdir` クレートを導入し、指定されたディレクトリ内のメディアファイルを再帰的に探索する機能を実装します。
    *   ファイル拡張子によるフィルタリングロジックを追加します。
4.  **時間フォーマット変換ユーティリティの追加**:
    *   `src/utils.rs` または新しいモジュールに、時間文字列を秒に変換する関数を追加します。
5.  **カバーアート処理の追加**:
    *   `image` クレートを使用して、抽出したカバーアートのリサイズと変換ロジックを実装します。
6.  **エラーハンドリングの改善**:
    *   `thiserror` クレートなどを利用して、カスタムエラー型を定義し、アプリケーション全体で一貫したエラー処理を実装します。
    *   ユーザーへのエラー通知をより詳細かつ分かりやすく改善します。
7.  **CLIオプションの拡張**:
    *   `clap` を使用して、`--peerflix-` や `--ffmpeg-` のようなプレフィックス付きオプションを解析し、それらを適切に処理するロジックを実装します。

これらのステップにより、Issue #7 で挙げられた機能のほとんどが実装され、より堅牢で機能豊富な `castnow` のRust版が完成に近づきます。
